name: CI for Values

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Helm Lint
        run: |
          helm repo add curity https://curityio.github.io/idsvr-helm/
          helm repo update
          helm template my-release curity/idsvr --values confs/dev/values.yaml > /dev/null
          helm template my-release curity/idsvr --values confs/acc/values.yaml > /dev/null
          helm template my-release curity/idsvr --values confs/prod/values.yaml > /dev/null


      - name: Validate Argo Manifests
        run: |
          python3 -c "import yaml, sys; [yaml.safe_load(open(f)) for f in sys.argv[1:]]" apps/*.yaml
      
      - name: Create PR and Enable Auto-Merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_EXISTS=$(gh pr list --base main --head develop --state open --json number -q '.[0].number')
            
            if [ -z "$PR_EXISTS" ]; then
              echo "Geen openstaande PR gevonden, nieuwe aanmaken..."
              pr_url=$(gh pr create \
                --base main \
                --head develop \
                --title "Auto-promotion: develop to main" \
                --body "Automatische update van de Curity configuratie.")
            else
              echo "Er bestaat al een PR (#$PR_EXISTS). We gebruiken die."
              pr_url="https://github.com/${{ github.repository }}/pull/$PR_EXISTS"
            fi
            
            echo "PR URL: $pr_url"
            gh pr merge "$pr_url" --auto --merge